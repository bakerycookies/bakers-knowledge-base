worker_processes 1;

events {
    worker_connections 1024;
}

http {
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    server {
        # Nginx 監聽容器內的 80 port (對應外部 11434)
        listen 80;
        server_name localhost;

        # --- 防火牆白名單 ACL ---
        
        # 允許 Docker 內部網段
        allow 10.168.89.0/24;

        # 允許信任 IP (請自行增減)
        allow 127.0.0.1;
        allow 172.16.2.73; 
        allow 192.168.2.198;

        # 拒絕其他所有連線 (Default Deny)
        deny all;

        # 禁止存取隱藏檔 (以 . 開頭的檔案)
        location ~ /\. {
            deny all;
            access_log off;
            log_not_found off;
        }
        

        location / {
            # 反向代理到 Ollama 容器
            proxy_pass http://ollama:11434;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            
            # 支援 LLM Streaming (打字機效果)
            proxy_buffering off;
            
            # 延長超時時間
            proxy_read_timeout 600s;
        }
    }
}
