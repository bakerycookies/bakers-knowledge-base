# Linux 磁碟擴充指南：建立新分割區與自動掛載 (fstab)

本指南將說明如何在 Linux 系統中，利用硬碟剩餘的閒置空間建立新分割區，並完成格式化、掛載以及設定開機自動掛載的完整流程。

---

## 📝 情境描述
當系統碟（例如 `/dev/nvme0n1`）的總容量大於目前已分配的分割區容量時，我們可以將剩餘空間建立為新的分割區使用。

*   **範例場景**：硬碟總量 4TB，但目前僅分配 500GB 給根目錄 `/`。
*   **目標**：將剩餘閒置空間 (Free Space) 建立為新分割區（如 `p3`），並掛載至 `/mnt/data` 供資料儲存使用。

---

## 🔍 1. 查詢磁碟狀態與剩餘空間
首先，我們需要確認硬碟目前的結構與未分配空間。

```bash
# 查看區塊裝置列表
lsblk

# 或者使用 cfdisk 進入圖形化介面查看（更直覺，推薦初學者使用）
sudo cfdisk /dev/nvme0n1
```

**判斷方式**：若磁碟總容量 (e.g., 3.7T) 遠大於所有分割區 (part) 的總和，即代表後方有未分配的閒置空間。

## 🛠️ 2. 建立新分割區 (Partitioning)
推薦使用 `cfdisk` 工具，其圖形介面操作簡單且不易出錯。

```bash
# 開啟指定硬碟（請務必確認硬碟代號，此處以 nvme0n1 為例）
sudo cfdisk /dev/nvme0n1
```

**操作步驟：**
1.  使用方向鍵 `↓` 移動到最下方的 **Free space**。
2.  選取下方的 **[ New ]**，按 `Enter`。
3.  **Partition size**：預設會自動帶入所有剩餘空間，直接按 `Enter` 即可。
4.  列表會出現新的分割區（例如 `nvme0n1p3`）。
5.  **寫入變更（關鍵步驟）**：選取下方的 **[ Write ]**，按 `Enter`。
6.  輸入 `yes` 並按 `Enter` 確認寫入。
7.  選取 **[ Quit ]** 離開。

## 🧹 3. 格式化分割區 (Formatting)
將新建立的分割區格式化為 `ext4` 檔案系統。

> ⚠️ **注意**：請務必確認分割區編號（例如 `p3`），切勿格式化到系統碟或含有重要資料的分割區。

```bash
# 格式化指定的分割區 (以 /dev/nvme0n1p3 為例)
sudo mkfs.ext4 /dev/nvme0n1p3
```

## 📂 4. 建立掛載點與測試掛載 (Mounting)
建立目錄並將新空間掛載上去，確認是否能正常運作。

```bash
# 1. 建立掛載點目錄
sudo mkdir -p /mnt/data

# 2. 執行暫時掛載測試
sudo mount /dev/nvme0n1p3 /mnt/data

# 3. 檢查掛載狀態
df -h
```
確認輸出結果的最後一行是否正確顯示 `/mnt/data` 及其容量。

## 🔑 5. 設定權限 (Permissions)
新掛載的目錄預設僅限 root 存取。為了讓一般使用者或 Docker 容器能正常讀寫，建議根據使用情境選擇以下其中一種方式調整權限：

### 方法 A：全開放權限 (適合測試環境)
此方式最為簡單，適合內部開發伺服器或單機 Docker Volume 使用。
```bash
# 開放所有使用者讀寫存取權限 (777)
sudo chmod 777 /mnt/data
```
> [!CAUTION]
> ⚠️ **安全提醒**：`777` 權限會導致任何使用者都能修改該目錄，具備較高安全風險。在正式或多用戶環境中，請謹慎使用。

### 方法 B：指定特定使用者 (推薦)
這是安全性較高的做法，僅授權給特定的使用者及其群組。
```bash
# 將目錄所有權移交給指定的使用者 (請將 username 替換為實際帳號)
sudo chown -R username:username /mnt/data
```

## 🔄 6. 設定開機自動掛載 (Fstab)

> [!WARNING]
> 🚨 **警告**：此步驟若設定錯誤可能導致系統無法開機。請務必謹慎操作，並執行最後的驗證步驟。

### 🆔 6-1. 查詢 UUID
建議使用 UUID 取代硬碟代號（如 `/dev/nvme0n1p3`），以避免因硬碟順序變動導致掛載失敗。

```bash
sudo blkid /dev/nvme0n1p3
```
複製輸出結果中 `UUID="..."` 雙引號內的字串。

### 📝 6-2. 編輯 /etc/fstab
使用文字編輯器開啟設定檔：
```bash
sudo nano /etc/fstab
```
在檔案最下方新增一行配置（請將範例 UUID 替換為你實際查詢到的值）：

```plaintext
# <file system>                           <mount point>   <type>  <options>   <dump>  <pass>
UUID=你的-UUID-貼在這裡-不要有引號   /mnt/data       ext4    defaults    0       2
```

### 🛡️ 6-3. 驗證設定 (安全檢查)
在重新開機前，**務必**執行以下指令測試 `fstab` 設定是否正確：

```bash
# 嘗試掛載 fstab 中的所有項目
sudo mount -a
```
- **若無任何錯誤訊息**：代表設定正確，可以安全重新開機。
- **若出現錯誤**：請立即檢查 `/etc/fstab` 內容並修正，**在錯誤修正前絕對不要重新開機**。